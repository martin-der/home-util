

def homeutilProjectDir = "${project.projectDir}/.."

def trimStart = {
	def start = "${project.projectDir}"
	it.startsWith(start) ? it.substring(start.size()) : it
}

def sourceDir = 'script'
def allSuccesful = true

class CommandTestTask extends DefaultTask {

	@Input
	String script

	@TaskAction
	def executeTest() {
		println "[ Testing $filename ]"
		task performTest(type: Exec) {
			//workingDir homeutilProjectDir
			commandLine 'bash', "$script"
			ignoreExitValue true
			doLast {
				if(execResult != 0) {
					allSuccesful = false
				}
			}
		}
	}
}


task testAllScripts() {

	doLast {
		println "All successful = $allSuccesful"
	}
}

def sourceDirectory = file("$sourceDir")
sourceDirectory.eachFileRecurse(groovy.io.FileType.FILES) {
	script ->
	if(script.name.endsWith('.sh')) {

		def trimmedStart = "${project.projectDir}/script/"
		def filename = "$script".startsWith(trimmedStart) ? "$script".substring(trimmedStart.size()) : "$file"
		println "[ $filename ]"
		task "performTest_$filename" (type: Exec) {
			workingDir homeutilProjectDir
			commandLine 'bash', "$script"
			ignoreExitValue false
			doLast {
				println "[Testing '$filename']"
				if(execResult != 0) {
					allSuccesful = false
				}
			}
		}

		testAllScripts.dependsOn("performTest_$filename")
	}
}


tasks.withType(Test) {
	testAllScripts
}


